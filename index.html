<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>A3 Extensions Directory</title>
<link rel="icon" type="image/png" href="logo.png">

<style>
/* UI PRINCIPLE: DESIGN TOKENS 
   We define our colors and spacing in variables for consistency.
   --base-size is the heart of the scaling feature.
*/
:root {
  --bg-dark: #020617;
  --bg-surface: #0f172a;
  --bg-surface-highlight: #1e293b;
  
  --primary: #38bdf8;
  --primary-dim: rgba(56, 189, 248, 0.15);
  
  --text-main: #f1f5f9;
  --text-muted: #94a3b8;
  --border: rgba(148, 163, 184, 0.15);
  
  --font-stack: system-ui, -apple-system, sans-serif;
  
  /* THE SCALING ENGINE */
  --base-size: 14px; /* Default size */
}

* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden; /* App-like feel */
  background-color: var(--bg-dark);
  font-family: var(--font-stack);
  color: var(--text-main);
  /* This applies the dynamic font size to the root of the document */
  font-size: var(--base-size);
  transition: font-size 0.2s ease; /* Smooth scaling */
}

/* ================= LAYOUT GRID ================= */

.app-container {
  max-width: 1200px;
  height: 100%;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  background: radial-gradient(circle at top right, #1e293b 0%, #020617 60%);
  position: relative;
}

/* ================= HEADER SECTION ================= */

header {
  padding: 1.5rem 1.5rem 1rem 1.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.brand {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.logo-frame {
  width: 3.5rem;
  height: 3.5rem;
  border-radius: 1rem;
  background: var(--bg-surface-highlight);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.logo-frame img { width: 70%; height: 70%; object-fit: contain; }

.headings h1 {
  font-size: 1.4rem;
  font-weight: 700;
  margin: 0;
  letter-spacing: -0.02em;
  color: #fff;
}
.headings p {
  margin: 0.2rem 0 0 0;
  font-size: 0.85rem;
  color: var(--text-muted);
}

.sync-status {
  width: 0.6rem;
  height: 0.6rem;
  border-radius: 50%;
  background: var(--primary);
  opacity: 0;
  transition: opacity 0.3s;
}
.sync-status.active { opacity: 1; animation: pulse 1.5s infinite; }

/* ================= TOOLBAR SECTION ================= */

.toolbar {
  padding: 1rem 1.5rem;
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: center;
  border-bottom: 1px solid var(--border);
  background: rgba(2, 6, 23, 0.5);
  backdrop-filter: blur(8px);
  z-index: 20;
}

/* Search Input */
.search-group {
  flex: 1;
  min-width: 200px;
  position: relative;
}
.search-group input {
  width: 100%;
  padding: 0.75rem 1rem 0.75rem 2.8rem;
  border-radius: 0.75rem;
  border: 1px solid var(--border);
  background: var(--bg-surface);
  color: #fff;
  font-size: 1rem;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.search-group input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-dim);
}
.search-icon {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 1rem;
}

/* Controls Group (Filters + Text Size) */
.controls-group {
  display: flex;
  gap: 0.8rem;
  align-items: center;
}

/* Button Reset */
.btn {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 0.6rem 1rem;
  border-radius: 0.6rem;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}
.btn:hover { background: var(--bg-surface-highlight); color: #fff; }
.btn.active {
  background: var(--primary-dim);
  color: var(--primary);
  border-color: rgba(56, 189, 248, 0.4);
}

/* Text Size Stepper */
.size-stepper {
  display: flex;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 0.6rem;
  overflow: hidden;
}
.size-btn {
  background: transparent;
  border: none;
  padding: 0.6rem 0.8rem;
  color: var(--text-main);
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s;
}
.size-btn:hover { background: var(--bg-surface-highlight); }
.size-label {
  border-left: 1px solid var(--border);
  border-right: 1px solid var(--border);
  padding: 0.6rem 0.6rem;
  font-size: 0.7rem;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  user-select: none;
}

/* RRT Info Badge */
.info-badge {
  font-size: 0.75rem;
  color: var(--text-muted);
  background: var(--primary-dim);
  padding: 0.5rem 1rem;
  border-radius: 2rem;
  border: 1px solid rgba(56, 189, 248, 0.2);
  white-space: nowrap;
}
.info-badge strong { color: var(--primary); }

/* ================= DATA VIEW (Scrollable) ================= */

.data-view {
  flex: 1;
  overflow: hidden; /* Container doesn't scroll */
  display: flex;
  flex-direction: column;
  position: relative;
}

.table-scroll {
  flex: 1;
  overflow-y: auto; /* Internal Scroll */
  padding: 0 1.5rem;
  
  /* Scrollbar Styling */
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}
.table-scroll::-webkit-scrollbar { width: 6px; }
.table-scroll::-webkit-scrollbar-track { background: transparent; }
.table-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

table {
  width: 100%;
  border-collapse: separate; 
  border-spacing: 0;
  margin-bottom: 2rem;
}

thead {
  position: sticky;
  top: 0;
  background: var(--bg-dark); /* Matches body bg for seamless stickiness */
  z-index: 10;
}
/* A visual trick to create a line under sticky header */
thead::after {
  content: '';
  position: absolute;
  left: 0; right: 0; bottom: 0;
  border-bottom: 1px solid var(--border);
}

th {
  text-align: left;
  padding: 1rem 0.5rem;
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  cursor: pointer;
  user-select: none;
}
th:hover { color: var(--text-main); }

td {
  padding: 1rem 0.5rem;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
  line-height: 1.5;
}

/* Row Animation */
tbody tr { animation: fadeIn 0.3s ease forwards; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* Cell Content Styling */
.category-tag {
  display: inline-block;
  font-size: 0.75rem;
  font-weight: 600;
  padding: 0.3em 0.8em;
  background: var(--bg-surface-highlight);
  color: #cbd5e1;
  border-radius: 0.4rem;
}

.service-text {
  font-weight: 500;
  color: var(--text-main);
  font-size: 1rem;
}

.ext-badge {
  font-family: 'SF Mono', 'Menlo', monospace;
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--primary);
  background: rgba(14, 165, 233, 0.1);
  padding: 0.4em 0.8em;
  border-radius: 0.4rem;
  display: inline-block;
}

.fav-btn {
  background: none;
  border: none;
  font-size: 1.2rem;
  color: #334155;
  cursor: pointer;
  transition: color 0.2s;
}
.fav-btn.active { color: #eab308; }
.fav-btn:hover { transform: scale(1.2); }

/* ================= FOOTER ================= */

footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.75rem;
  color: var(--text-muted);
  background: var(--bg-surface);
}

/* ================= MOBILE ADAPTATION ================= */
@media (max-width: 768px) {
  header { padding: 1rem; flex-direction: column; gap: 1rem; text-align: center; }
  .brand { flex-direction: column; gap: 0.5rem; }
  .logo-frame { width: 3rem; height: 3rem; }
  
  .toolbar { padding: 0.8rem 1rem; flex-direction: column; align-items: stretch; gap: 0.8rem; }
  .controls-group { justify-content: space-between; }
  
  .table-scroll { padding: 0 1rem; }
  
  /* On Mobile, convert table to cards if simpler, or keep scroll */
  /* Keeping scroll as requested, but shrinking fonts slightly via JS logic */
}

@keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

</style>
</head>
<body>

<div class="app-container">

  <header>
    <div class="brand">
      <div class="logo-frame">
        <img src="logo.png" alt="A3">
      </div>
      <div class="headings">
        <h1>A3 Extensions</h1>
        <p>Created by F1520110 ‚Äì Nawaf Alshammari</p>
      </div>
    </div>
    <div id="sync-indicator" class="sync-status"></div>
  </header>

  <section class="toolbar">
    <div class="search-group">
      <span class="search-icon">üîç</span>
      <input id="search" type="search" placeholder="Search service, category..." autocomplete="off">
    </div>

    <div class="controls-group">
      <button id="filter-all" class="btn active">All</button>
      <button id="filter-fav" class="btn">‚òÖ Favorites</button>

      <div class="size-stepper">
        <button class="size-btn" onclick="changeSize(-1)" title="Decrease Size">A-</button>
        <div class="size-label">SIZE</div>
        <button class="size-btn" onclick="changeSize(1)" title="Increase Size">A+</button>
      </div>
    </div>

    <div class="info-badge">
      RRT: Adult <strong>49337</strong> ‚Ä¢ Ped <strong>45381</strong>
    </div>
  </section>

  <main class="data-view">
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th width="50" style="text-align:center">‚òÖ</th>
            <th class="sortable" data-col="category">Category</th>
            <th class="sortable" data-col="service">Service</th>
            <th class="sortable" data-col="extension">Ext</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <footer>
    <span>Not an official hospital system. Internal use only.</span>
    <span style="color:var(--primary); font-weight:700; font-size:0.7rem; border:1px solid var(--primary-dim); padding:2px 6px; border-radius:4px;">LIVE V2.0</span>
  </footer>

</div>

<script>
// --- CORE VARIABLES ---
const tbody       = document.getElementById('tbody');
const searchInput = document.getElementById('search');
const btnAll      = document.getElementById('filter-all');
const btnFav      = document.getElementById('filter-fav');
const syncDot     = document.getElementById('sync-indicator');
const sortHeaders = document.querySelectorAll('th.sortable');

const STORAGE_KEY_DATA = 'a3_directory_data_v2'; // Changed key for v2 structure
const STORAGE_KEY_FAV  = 'a3_directory_favorites_v1';
const STORAGE_KEY_SIZE = 'a3_ui_size';

let data = [];
let favorites = new Set();
let currentView = 'all';
let sortState = { column: null, dir: 1 };

// --- TEXT SCALING ENGINE ---
let baseFontSize = 14; // Default pixels

function initSize() {
  const savedSize = localStorage.getItem(STORAGE_KEY_SIZE);
  if (savedSize) {
    baseFontSize = parseInt(savedSize);
  }
  applySize();
}

function changeSize(amount) {
  baseFontSize += amount;
  // Limits: Min 10px, Max 22px
  if (baseFontSize < 10) baseFontSize = 10;
  if (baseFontSize > 22) baseFontSize = 22;
  
  applySize();
  localStorage.setItem(STORAGE_KEY_SIZE, baseFontSize);
}

function applySize() {
  // Update the CSS variable --base-size
  document.documentElement.style.setProperty('--base-size', baseFontSize + 'px');
}

// --- DATA LOGIC ---

function makeKey(row) {
  return `${row.category}||${row.service}||${row.extension}`;
}

function loadFavorites() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY_FAV);
    if (raw) favorites = new Set(JSON.parse(raw));
  } catch (e) { favorites = new Set(); }
}

function saveFavorites() {
  localStorage.setItem(STORAGE_KEY_FAV, JSON.stringify(Array.from(favorites)));
}

function escapeRegex(str) { return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

function getFilteredData() {
  const q = searchInput.value.toLowerCase().trim();
  let re = null;
  if (q) re = new RegExp('\\b' + escapeRegex(q));

  return data.filter(row => {
    const key = makeKey(row);
    const inView = currentView === 'all' || (currentView === 'fav' && favorites.has(key));
    
    if (!inView) return false;
    if (!q) return true;

    return (re.test((row.category||'').toLowerCase()) || 
            re.test((row.service||'').toLowerCase()) || 
            re.test((row.extension||'').toLowerCase()));
  });
}

function applySort(list) {
  if (!sortState.column) return list;
  const col = sortState.column;
  const dir = sortState.dir;

  return [...list].sort((a, b) => {
    let va = a[col] ?? '';
    let vb = b[col] ?? '';
    if (col === 'extension') {
      va = parseInt(va, 10) || 0;
      vb = parseInt(vb, 10) || 0;
    } else {
      va = va.toString().toLowerCase();
      vb = vb.toString().toLowerCase();
    }
    return (va < vb ? -1 : 1) * dir;
  });
}

function renderRows(list) {
  tbody.innerHTML = "";
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:3rem; color:var(--text-muted);">No results found.</td></tr>`;
    return;
  }

  const fragment = document.createDocumentFragment();
  
  list.forEach(row => {
    const key = makeKey(row);
    const isFav = favorites.has(key);
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:center;">
        <button class="fav-btn${isFav ? ' active' : ''}" data-key="${key}">‚òÖ</button>
      </td>
      <td><span class="category-tag">${row.category || ''}</span></td>
      <td><span class="service-text">${row.service || ''}</span></td>
      <td><span class="ext-badge">${row.extension || ''}</span></td>
    `;
    fragment.appendChild(tr);
  });
  
  tbody.appendChild(fragment);
}

// --- EVENT LISTENERS ---

tbody.addEventListener('click', (e) => {
  if (!e.target.classList.contains('fav-btn')) return;
  const key = e.target.getAttribute('data-key');
  if (favorites.has(key)) {
    favorites.delete(key);
    e.target.classList.remove('active');
  } else {
    favorites.add(key);
    e.target.classList.add('active');
  }
  saveFavorites();
  // Remove from view immediately if in Fav view
  if(currentView === 'fav') updateView();
});

btnAll.addEventListener('click', () => {
  currentView = 'all';
  btnAll.classList.add('active');
  btnFav.classList.remove('active');
  updateView();
});

btnFav.addEventListener('click', () => {
  currentView = 'fav';
  btnFav.classList.add('active');
  btnAll.classList.remove('active');
  updateView();
});

searchInput.addEventListener('input', updateView);

sortHeaders.forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.col;
    if (sortState.column === col) {
      sortState.dir *= -1;
    } else {
      sortState.column = col;
      sortState.dir = 1;
    }
    updateView();
  });
});

function updateView() {
  const filtered = getFilteredData();
  const sorted = applySort(filtered);
  renderRows(sorted);
}

// --- SYNC ---

function callback(response) {
  const prev = localStorage.getItem(STORAGE_KEY_DATA);
  const next = JSON.stringify(response);
  syncDot.classList.remove('active');
  if (prev !== next) {
    localStorage.setItem(STORAGE_KEY_DATA, next);
    data = response;
  } else if (!data.length) {
    data = response;
  }
  updateView();
}

function loadData() {
  syncDot.classList.add('active');
  loadFavorites();
  initSize(); // Init text size

  const cached = localStorage.getItem(STORAGE_KEY_DATA);
  if (cached) {
    try { data = JSON.parse(cached) || []; } catch(e){ data=[]; }
  }
  updateView();

  const script = document.createElement('script');
  script.src = "https://script.google.com/macros/s/AKfycby9t71TVzAJyzRDczYYtLh7oIIq9J4jEvyddy7Bc-BAunFMTuYEwerlscLHjfKw0orA/exec";
  document.body.appendChild(script);
}

loadData();
</script>

</body>
</html>