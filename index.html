<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>A3 Directory</title>
<link rel="icon" type="image/png" href="logo.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* --- MODERN 2025 DESIGN SYSTEM --- */
:root {
  /* Deep Space Color Palette */
  --bg-deep: #030712;
  --bg-surface: #0f172a;
  --bg-elevated: #1e293b;
  
  /* Glassmorphism & Depth */
  --glass-primary: rgba(17, 25, 40, 0.75);
  --glass-secondary: rgba(30, 41, 59, 0.5);
  --glass-border: rgba(255, 255, 255, 0.08);
  --glass-highlight: rgba(255, 255, 255, 0.05);
  
  /* Brand Colors */
  --primary: #3b82f6;
  --primary-light: #60a5fa;
  --primary-dark: #2563eb;
  --primary-glow: rgba(59, 130, 246, 0.15);
  
  --accent: #f43f5e;
  --accent-light: #fb7185;
  --accent-bg: rgba(244, 63, 94, 0.1);
  
  --success: #10b981;
  --warning: #f59e0b;
  
  /* Typography */
  --text-primary: #f8fafc;
  --text-secondary: #cbd5e1;
  --text-tertiary: #64748b;
  
  --font-stack: 'Inter', system-ui, -apple-system, sans-serif;
  
  /* Spacing & Sizing */
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --radius-xl: 24px;
  
  /* Shadows & Effects */
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.25);
  --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.3);
  --shadow-lg: 0 20px 50px rgba(0, 0, 0, 0.4);
  
  /* Transitions */
  --transition-fast: 0.15s ease;
  --transition-normal: 0.25s ease;
  --transition-slow: 0.35s ease;
  
  /* Layout */
  --header-height: 80px;
  --footer-height: 60px;
  
  /* Base font size for responsive scaling */
  --base-size: 14px;
}

/* --- RESET & BASE STYLES --- */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

html {
  font-size: var(--base-size);
  background-color: var(--bg-deep);
  color: var(--text-primary);
  font-family: var(--font-stack);
  overflow-x: hidden;
  height: 100%;
  -webkit-text-size-adjust: 100%;
}

body {
  min-height: 100vh;
  background: 
    radial-gradient(ellipse at 20% 20%, rgba(30, 41, 59, 0.4) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 80%, rgba(15, 23, 42, 0.3) 0%, transparent 50%),
    radial-gradient(ellipse at 40% 40%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
    linear-gradient(180deg, var(--bg-deep) 0%, var(--bg-surface) 100%);
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

/* --- APP CONTAINER --- */
.app-container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  max-width: 100%;
  overflow: hidden;
}

/* --- HEADER --- */
.header {
  height: var(--header-height);
  padding: 0 1.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--glass-primary);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--glass-border);
  position: sticky;
  top: 0;
  z-index: 100;
}

/* Brand Section */
.brand {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.logo-container {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-md);
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow: hidden;
}

.logo-container::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
}

.logo-container img {
  width: 60%;
  height: 60%;
  object-fit: contain;
  position: relative;
  z-index: 2;
  filter: brightness(0) invert(1);
}

.brand-text {
  display: flex;
  flex-direction: column;
}

.brand-name {
  font-size: 1.2rem;
  font-weight: 700;
  letter-spacing: -0.02em;
  background: linear-gradient(to right, #fff, var(--text-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.brand-subtitle {
  font-size: 0.75rem;
  color: var(--text-tertiary);
  margin-top: 2px;
}

/* Stats Section */
.stats-container {
  display: flex;
  align-items: center;
  gap: 1.5rem;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: var(--glass-secondary);
  border: 1px solid var(--glass-border);
  padding: 0.5rem 1rem;
  border-radius: var(--radius-xl);
  backdrop-filter: blur(5px);
  box-shadow: var(--shadow-sm);
}

.live-indicator {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--success);
}

.pulse-dot {
  width: 8px;
  height: 8px;
  background: var(--success);
  border-radius: 50%;
  box-shadow: 0 0 8px var(--success);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.stat-value {
  font-weight: 700;
  color: var(--accent);
  background: var(--accent-bg);
  padding: 2px 6px;
  border-radius: var(--radius-sm);
  font-family: 'SF Mono', 'Roboto Mono', monospace;
}

/* Search & Controls */
.controls-container {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.search-wrapper {
  position: relative;
  width: 280px;
}

.search-input {
  width: 100%;
  background: var(--glass-secondary);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  padding: 0.75rem 1rem 0.75rem 2.5rem;
  color: var(--text-primary);
  font-family: var(--font-stack);
  font-size: 0.9rem;
  transition: all var(--transition-normal);
}

.search-input:focus {
  background: var(--glass-primary);
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-glow);
}

.search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-tertiary);
  pointer-events: none;
}

.control-buttons {
  display: flex;
  gap: 0.5rem;
}

.btn {
  background: var(--glass-secondary);
  border: 1px solid var(--glass-border);
  color: var(--text-secondary);
  height: 40px;
  padding: 0 1rem;
  border-radius: var(--radius-md);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  font-weight: 500;
  font-size: 0.85rem;
  transition: all var(--transition-fast);
  white-space: nowrap;
}

.btn:hover {
  background: var(--glass-highlight);
  color: var(--text-primary);
  border-color: var(--text-tertiary);
}

.btn.active {
  background: var(--primary-glow);
  color: var(--primary);
  border-color: rgba(59, 130, 246, 0.3);
}

.btn-icon {
  width: 36px;
  padding: 0;
}

/* --- MAIN CONTENT --- */
.main-content {
  flex: 1;
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.content-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
}

.results-count {
  font-size: 0.9rem;
  color: var(--text-tertiary);
}

/* Table Container */
.table-container {
  flex: 1;
  background: var(--glass-primary);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  backdrop-filter: blur(10px);
  overflow: hidden;
  box-shadow: var(--shadow-md);
  display: flex;
  flex-direction: column;
}

.table-header {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--glass-border);
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.table-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
}

.table-actions {
  display: flex;
  gap: 0.5rem;
}

.table-scroll {
  flex: 1;
  overflow: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--glass-border) transparent;
}

.table-scroll::-webkit-scrollbar {
  width: 6px;
}

.table-scroll::-webkit-scrollbar-track {
  background: transparent;
}

.table-scroll::-webkit-scrollbar-thumb {
  background: var(--glass-border);
  border-radius: 10px;
}

/* Table Styles */
table {
  width: 100%;
  border-collapse: collapse;
}

thead {
  position: sticky;
  top: 0;
  z-index: 10;
  background: var(--bg-surface);
}

thead th {
  text-align: left;
  padding: 1rem 1.5rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-tertiary);
  border-bottom: 1px solid var(--glass-border);
  cursor: pointer;
  transition: color var(--transition-fast);
  user-select: none;
}

thead th:hover {
  color: var(--primary);
}

thead th i {
  margin-left: 0.5rem;
  opacity: 0.5;
}

tbody tr {
  transition: background-color var(--transition-fast);
  border-bottom: 1px solid rgba(255, 255, 255, 0.02);
}

tbody tr:hover {
  background: var(--glass-highlight);
}

td {
  padding: 1rem 1.5rem;
  vertical-align: middle;
}

/* Table Cell Styles */
.fav-cell {
  width: 50px;
  text-align: center;
}

.fav-btn {
  background: none;
  border: none;
  color: var(--text-tertiary);
  font-size: 1.1rem;
  cursor: pointer;
  transition: all var(--transition-fast);
  padding: 0.25rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
}

.fav-btn:hover {
  background: rgba(251, 191, 36, 0.1);
  color: #fbbf24;
}

.fav-btn.active {
  color: #fbbf24;
  filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.4));
}

.category-cell {
  width: 25%;
}

.category-tag {
  display: inline-block;
  background: var(--glass-secondary);
  border: 1px solid var(--glass-border);
  color: var(--text-secondary);
  padding: 0.4rem 0.8rem;
  border-radius: var(--radius-md);
  font-size: 0.8rem;
  font-weight: 500;
  letter-spacing: 0.02em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

.service-cell {
  width: auto;
}

.service-name {
  font-weight: 500;
  color: var(--text-primary);
  font-size: 0.95rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.extension-cell {
  width: 150px;
  text-align: right;
}

.extension-badge {
  font-family: 'SF Mono', 'Roboto Mono', monospace;
  font-weight: 600;
  font-size: 0.95rem;
  color: var(--primary);
  letter-spacing: -0.02em;
  display: inline-block;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.15);
  padding: 0.4rem 0.8rem;
  border-radius: var(--radius-md);
  white-space: nowrap;
}

/* --- FOOTER --- */
.footer {
  height: var(--footer-height);
  padding: 0 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-surface);
  border-top: 1px solid var(--glass-border);
  font-size: 0.8rem;
  color: var(--text-tertiary);
}

.footer-disclaimer {
  opacity: 0.7;
}

.sync-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  color: var(--text-secondary);
}

.sync-dot {
  width: 6px;
  height: 6px;
  background: var(--success);
  border-radius: 50%;
  box-shadow: 0 0 8px var(--success);
}

/* --- EMPTY STATE --- */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem 1.5rem;
  text-align: center;
  color: var(--text-tertiary);
}

.empty-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--text-secondary);
}

.empty-description {
  font-size: 0.9rem;
  max-width: 300px;
}

/* --- RESPONSIVE DESIGN --- */

/* Tablet */
@media (max-width: 1024px) {
  .header {
    padding: 0 1rem;
  }
  
  .main-content {
    padding: 1rem;
  }
  
  .stats-container {
    gap: 1rem;
  }
  
  .search-wrapper {
    width: 240px;
  }
}

/* Mobile */
@media (max-width: 768px) {
  :root {
    --header-height: 70px;
    --base-size: 13px;
  }
  
  .header {
    flex-wrap: wrap;
    height: auto;
    min-height: var(--header-height);
    padding: 0.75rem 1rem;
    gap: 0.75rem;
  }
  
  .brand {
    order: 1;
  }
  
  .controls-container {
    order: 3;
    width: 100%;
    justify-content: space-between;
  }
  
  .search-wrapper {
    width: 100%;
    max-width: 300px;
  }
  
  .stats-container {
    order: 2;
    margin-left: auto;
  }
  
  .stat-card {
    padding: 0.4rem 0.8rem;
    gap: 0.5rem;
  }
  
  .stat-item {
    font-size: 0.8rem;
  }
  
  .main-content {
    padding: 1rem;
  }
  
  .content-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .table-header {
    padding: 0.75rem 1rem;
  }
  
  thead th, td {
    padding: 0.75rem 1rem;
  }
  
  /* Mobile table adjustments */
  .category-cell {
    width: 30%;
  }
  
  .extension-cell {
    width: 120px;
  }
}

/* Small Mobile */
@media (max-width: 480px) {
  :root {
    --base-size: 12px;
  }
  
  .header {
    padding: 0.5rem;
  }
  
  .brand {
    gap: 0.5rem;
  }
  
  .logo-container {
    width: 40px;
    height: 40px;
  }
  
  .brand-name {
    font-size: 1rem;
  }
  
  .brand-subtitle {
    font-size: 0.7rem;
  }
  
  .stats-container {
    gap: 0.5rem;
  }
  
  .stat-card {
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.4rem;
  }
  
  .stat-item {
    font-size: 0.75rem;
  }
  
  .controls-container {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .search-wrapper {
    max-width: 100%;
  }
  
  .control-buttons {
    width: 100%;
    justify-content: space-between;
  }
  
  .btn {
    flex: 1;
    font-size: 0.8rem;
  }
  
  .main-content {
    padding: 0.5rem;
  }
  
  .table-container {
    border-radius: var(--radius-md);
  }
  
  thead th, td {
    padding: 0.75rem 0.5rem;
  }
  
  .footer {
    padding: 0 1rem;
    flex-direction: column;
    gap: 0.5rem;
    height: auto;
    padding: 0.75rem 1rem;
  }
}

/* Extra Small Mobile */
@media (max-width: 360px) {
  .stat-card {
    padding: 0.3rem;
  }
  
  .stat-item {
    font-size: 0.7rem;
  }
  
  .btn {
    padding: 0 0.5rem;
    font-size: 0.75rem;
  }
  
  .category-tag, .extension-badge {
    font-size: 0.75rem;
    padding: 0.3rem 0.6rem;
  }
}

/* Dark mode preference enhancements */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-deep: #030712;
    --bg-surface: #0f172a;
  }
}

/* Reduced motion for accessibility */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  
  .pulse-dot {
    animation: none;
  }
}

/* High contrast mode */
@media (prefers-contrast: high) {
  :root {
    --glass-border: rgba(255, 255, 255, 0.3);
    --text-primary: #ffffff;
    --text-secondary: #e2e8f0;
  }
}

/* Print styles */
@media print {
  :root {
    --bg-deep: white;
    --text-primary: black;
    --text-secondary: #333;
  }
  
  .header, .footer, .control-buttons, .search-wrapper {
    display: none;
  }
  
  .table-container {
    box-shadow: none;
    border: 1px solid #ddd;
  }
}
</style>
</head>
<body>

<div class="app-container">
  <!-- Header -->
  <header class="header">
    <div class="brand">
      <div class="logo-container">
        <img src="logo.png" alt="A3" onerror="this.style.display='none'; this.parentElement.innerHTML='A3'">
      </div>
      <div class="brand-text">
        <div class="brand-name">A3 Directory</div>
        <div class="brand-subtitle">King Faisal Specialist Hospital</div>
      </div>
    </div>

    <div class="stats-container">
      <div class="stat-card">
        <div class="live-indicator">
          <span class="pulse-dot"></span>
          <span>LIVE</span>
        </div>
        <div class="stat-item">
          Adult <span class="stat-value">49337</span>
        </div>
        <div class="stat-item">
          Pediatric <span class="stat-value">45381</span>
        </div>
      </div>
    </div>

    <div class="controls-container">
      <div class="search-wrapper">
        <i class="search-icon fas fa-search"></i>
        <input id="search" type="text" class="search-input" placeholder="Search directory..." autocomplete="off">
      </div>

      <div class="control-buttons">
        <button id="filter-all" class="btn active">All</button>
        <button id="filter-fav" class="btn">
          <i class="fas fa-star"></i> Favorites
        </button>
        <div class="btn btn-icon" onclick="resize(-1)">
          <i class="fas fa-font"></i> <span class="mobile-hidden">A-</span>
        </div>
        <div class="btn btn-icon" onclick="resize(1)">
          <i class="fas fa-font"></i> <span class="mobile-hidden">A+</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="content-header">
      <h2 class="section-title">Internal Extensions</h2>
      <div class="results-count" id="results-count">Showing all extensions</div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <div class="table-title">Directory</div>
        <div class="table-actions">
          <!-- Additional actions could go here -->
        </div>
      </div>

      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th width="50" class="sortable" data-col="favorite">
                <i class="fas fa-star"></i>
              </th>
              <th class="sortable" data-col="category">Category</th>
              <th class="sortable" data-col="service">Service</th>
              <th class="sortable" data-col="extension" style="text-align:right">Extension</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- Table rows will be inserted here by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-disclaimer">
      This project is a personal initiative and is not an official hospital system.
    </div>
    <div class="sync-status">
      SYNC <span id="sync-dot" class="sync-dot"></span>
    </div>
  </footer>
</div>

<script>
// --- CONFIG & STATE ---
const STORAGE_KEY_DATA = 'a3_data_v5';
const STORAGE_KEY_FAV  = 'a3_fav_v5';
const STORAGE_KEY_SIZE = 'a3_size_v5';

let data = [];
let favorites = new Set();
let currentView = 'all';
let sortState = { col: null, dir: 1 };
let baseSize = 14;

// --- ELEMENTS ---
const tbody = document.getElementById('tbody');
const searchInput = document.getElementById('search');
const btnAll = document.getElementById('filter-all');
const btnFav = document.getElementById('filter-fav');
const syncDot = document.getElementById('sync-dot');
const resultsCount = document.getElementById('results-count');

// --- HELPER FOR REGEX ---
function escapeRegex(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// --- INIT ---
function init() {
  const s = localStorage.getItem(STORAGE_KEY_SIZE);
  if(s) baseSize = parseInt(s);
  applySize();

  const f = localStorage.getItem(STORAGE_KEY_FAV);
  if(f) favorites = new Set(JSON.parse(f));

  const d = localStorage.getItem(STORAGE_KEY_DATA);
  if(d) {
    try { data = JSON.parse(d)||[]; } catch(e){ data=[]; }
    render();
  }

  fetchData();
}

// --- LOGIC ---
function resize(delta) {
  baseSize += delta;
  if(baseSize < 12) baseSize = 12;
  if(baseSize > 24) baseSize = 24; 
  applySize();
  localStorage.setItem(STORAGE_KEY_SIZE, baseSize);
}

function applySize() {
  document.documentElement.style.setProperty('--base-size', baseSize + 'px');
}

function fetchData() {
  syncDot.style.opacity = '0.4';
  const script = document.createElement('script');
  script.src = "https://script.google.com/macros/s/AKfycby9t71TVzAJyzRDczYYtLh7oIIq9J4jEvyddy7Bc-BAunFMTuYEwerlscLHjfKw0orA/exec";
  document.body.appendChild(script);
}

function callback(response) {
  syncDot.style.opacity = '1';
  const prev = localStorage.getItem(STORAGE_KEY_DATA);
  const next = JSON.stringify(response);
  if(prev !== next) {
    localStorage.setItem(STORAGE_KEY_DATA, next);
    data = response;
    render();
  } else if (data.length === 0) {
    data = response;
    render();
  }
}

function render() {
  tbody.innerHTML = '';
  const q = searchInput.value.toLowerCase().trim();
  let re = null;
  if (q) {
    re = new RegExp('\\b' + escapeRegex(q));
  }
  
  let list = data.filter(row => {
    const key = makeKey(row);
    if(currentView === 'fav' && !favorites.has(key)) return false;
    if(!q) return true;
    
    const cat = String(row.category || '').toLowerCase();
    const svc = String(row.service || '').toLowerCase();
    const ext = String(row.extension || '').toLowerCase();

    return re.test(cat) || re.test(svc) || re.test(ext);
  });

  if(sortState.col) {
    const col = sortState.col;
    const dir = sortState.dir;
    list.sort((a,b) => {
      let va = a[col]||''; let vb = b[col]||'';
      if(col==='extension') { va=parseInt(va)||0; vb=parseInt(vb)||0; }
      else { va=va.toString().toLowerCase(); vb=vb.toString().toLowerCase(); }
      return (va < vb ? -1 : 1) * dir;
    });
  }

  // Update results count
  updateResultsCount(list.length, q);
  
  if(list.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4">
          <div class="empty-state">
            <div class="empty-icon">
              <i class="fas fa-search"></i>
            </div>
            <div class="empty-title">No results found</div>
            <div class="empty-description">
              ${q ? 'Try adjusting your search terms or filters' : 'No extensions available'}
            </div>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  const frag = document.createDocumentFragment();
  list.forEach(row => {
    const key = makeKey(row);
    const isFav = favorites.has(key);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="fav-cell">
        <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFav('${key}')">
          <i class="fas fa-star"></i>
        </button>
      </td>
      <td class="category-cell">
        <span class="category-tag">${row.category || ''}</span>
      </td>
      <td class="service-cell">
        <span class="service-name">${row.service || ''}</span>
      </td>
      <td class="extension-cell">
        <span class="extension-badge">${row.extension || ''}</span>
      </td>
    `;
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
}

function updateResultsCount(count, query) {
  if (query) {
    resultsCount.textContent = `Found ${count} extension${count !== 1 ? 's' : ''} for "${query}"`;
  } else if (currentView === 'fav') {
    resultsCount.textContent = `Showing ${count} favorite extension${count !== 1 ? 's' : ''}`;
  } else {
    resultsCount.textContent = `Showing all ${count} extension${count !== 1 ? 's' : ''}`;
  }
}

function toggleFav(key) {
  if(favorites.has(key)) favorites.delete(key);
  else favorites.add(key);
  localStorage.setItem(STORAGE_KEY_FAV, JSON.stringify([...favorites]));
  render();
}

function makeKey(r) { return `${r.category}|${r.service}|${r.extension}`; }

// --- EVENTS ---
searchInput.addEventListener('input', render);

btnAll.addEventListener('click', () => {
  currentView='all'; 
  btnAll.classList.add('active'); 
  btnFav.classList.remove('active'); 
  render();
});

btnFav.addEventListener('click', () => {
  currentView='fav'; 
  btnFav.classList.add('active'); 
  btnAll.classList.remove('active'); 
  render();
});

document.querySelectorAll('.sortable').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.col;
    if(sortState.col === col) sortState.dir *= -1;
    else { sortState.col = col; sortState.dir = 1; }
    
    // Update sort indicators
    document.querySelectorAll('.sortable i').forEach(icon => {
      icon.className = 'fas fa-sort';
    });
    
    const icon = th.querySelector('i');
    if(icon) {
      icon.className = sortState.dir === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }
    
    render();
  });
});

// Initialize the app
init();
</script>

</body>
</html>